<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="安全技术入侵检测与管理系统（Intrusion Detection Systems）：特点是不阻断任何网络访问，量化、定位来自内外网络的威胁情况，主要以提供报告和事后监督为主，提供有针对性的指导措施和安全决策依据。一般采用旁路部署方式 入侵防御系统（Intrusion Prevention System）：以透明模式工作，分析数据包的内容如：溢出攻击、拒绝服务攻击、木马、蠕虫、系统漏洞等进行准确的">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux防火墙iptables">
<meta property="og:url" content="http://yoursite.com/2018/12/22/iptables/index.html">
<meta property="og:site_name" content="海之子">
<meta property="og:description" content="安全技术入侵检测与管理系统（Intrusion Detection Systems）：特点是不阻断任何网络访问，量化、定位来自内外网络的威胁情况，主要以提供报告和事后监督为主，提供有针对性的指导措施和安全决策依据。一般采用旁路部署方式 入侵防御系统（Intrusion Prevention System）：以透明模式工作，分析数据包的内容如：溢出攻击、拒绝服务攻击、木马、蠕虫、系统漏洞等进行准确的">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://yoursite.com/images/iptables.png">
<meta property="og:image" content="http://yoursite.com/images/iptables1.png">
<meta property="og:image" content="http://yoursite.com/images/iptables2.jpg">
<meta property="og:image" content="http://yoursite.com/images/iptables3.png">
<meta property="og:image" content="http://yoursite.com/images/iptables4.png">
<meta property="og:updated_time" content="2018-12-22T13:00:11.883Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Linux防火墙iptables">
<meta name="twitter:description" content="安全技术入侵检测与管理系统（Intrusion Detection Systems）：特点是不阻断任何网络访问，量化、定位来自内外网络的威胁情况，主要以提供报告和事后监督为主，提供有针对性的指导措施和安全决策依据。一般采用旁路部署方式 入侵防御系统（Intrusion Prevention System）：以透明模式工作，分析数据包的内容如：溢出攻击、拒绝服务攻击、木马、蠕虫、系统漏洞等进行准确的">
<meta name="twitter:image" content="http://yoursite.com/images/iptables.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/12/22/iptables/"/>





  <title>Linux防火墙iptables | 海之子</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">海之子</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/22/iptables/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="WPY">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/yy.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="海之子">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Linux防火墙iptables</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-22T19:55:57+08:00">
                2018-12-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/iptables/" itemprop="url" rel="index">
                    <span itemprop="name">iptables</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="安全技术"><a href="#安全技术" class="headerlink" title="安全技术"></a>安全技术</h1><p>入侵检测与管理系统（Intrusion Detection Systems）：特点是不阻断任何网络访问，量化、定位来自内外网络的威胁情况，主要以提供报告和事后监督为主，提供有针对性的指导措施和安全决策依据。一般采用旁路部署方式</p>
<p>入侵防御系统（Intrusion Prevention System）：以透明模式工作，分析数据包的内容如：溢出攻击、拒绝服务攻击、木马、蠕虫、系统漏洞等进行准确的分析判断，在判定为攻击行为后立即予以阻断，主动而有效的保护网络的安全，一般采用在线部署方式</p>
<p>防火墙（ FireWall ）：隔离功能，工作在网络或主机边缘，对进出网络或主机的数据包基于一定的规则检查，并在匹配某规则时由规则定义的行为进行处理的一组功能的组件，基本上的实现都是默认情况下关闭所有的通过型访问，只开放允许访问的策略</p>
<h1 id="防火墙的分类"><a href="#防火墙的分类" class="headerlink" title="防火墙的分类"></a>防火墙的分类</h1><p>主机防火墙：服务范围为当前主机</p>
<p>网络防火墙：服务范围为防火墙一侧的局域网</p>
<p>硬件防火墙：在专用硬件级别实现部分功能的防火墙；另一个部分功能基于软件实现，Checkpoint,NetScreen</p>
<p>软件防火墙：运行于通用硬件平台之上的防火墙的应用软件</p>
<p>网络层防火墙：OSI模型下四层：应用层防火墙/代理服务器：代理网关，OSI模型七层</p>
<h2 id="网络型防火墙"><a href="#网络型防火墙" class="headerlink" title="网络型防火墙"></a>网络型防火墙</h2><pre><code>网络层防火墙
包过滤防火墙
网络层对数据包进行选择，选择的依据是系统内设置的过滤逻辑，被称为访问控制列表（ACL），通过检查数据流中每个数据的源地址，目的地址，所用端口号和协议状态等因素，或他们的组合来确定是否允许该数据包通过
优点：对用户来说透明，处理速度快且易于维护
缺点：无法检查应用层数据，如病毒等
</code></pre><p><img src="/images/iptables.png" alt="Alt text"></p>
<h2 id="应用层防火墙"><a href="#应用层防火墙" class="headerlink" title="应用层防火墙"></a>应用层防火墙</h2><pre><code>应用层防火墙/代理服务型防火墙（Proxy Service）
 将所有跨越防火墙的网络通信链路分为两段
 内外网用户的访问都是通过代理服务器上的“链接”来实现
 优点：在应用层对数据进行检查，比较安全
 缺点：增加防火墙的负载
</code></pre><p><img src="/images/iptables1.png" alt="Alt text"></p>
<p>现实生产环境中所使用的防火墙一般都是二者结合体。即先检查网络数据，通过之后再送到应用层去检查。</p>
<h1 id="iptables的基本认识"><a href="#iptables的基本认识" class="headerlink" title="iptables的基本认识"></a>iptables的基本认识</h1><h2 id="Netfilter组件"><a href="#Netfilter组件" class="headerlink" title="Netfilter组件"></a>Netfilter组件</h2><pre><code>内核空间，集成在linux内核中
扩展各种网络服务的结构化底层框架
内核中选取五个位置放了五个hook(勾子) function(INPUT、OUTPUT、FORWARD、PREROUTING、POSTROUTING)，而这五个hook function向用户开放，用户可以通过一个命令工具（iptables）向其写入规则

由信息过滤表（table）组成，包含控制IP包处理的规则集（rules），规则被分组放在链（chain）上
</code></pre><h2 id="三种报文流向"><a href="#三种报文流向" class="headerlink" title="三种报文流向"></a>三种报文流向</h2><pre><code>流入本机：PREROUTING --&gt; INPUT--&gt;用户空间进程
流出本机：用户空间进程 --&gt;OUTPUT--&gt; POSTROUTING
转发：PREROUTING --&gt; FORWARD --&gt; POSTROUTING
</code></pre><h2 id="防火墙工具"><a href="#防火墙工具" class="headerlink" title="防火墙工具"></a>防火墙工具</h2><p>iptables<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">命令行工具，工作在用户空间</span><br><span class="line">用来编写规则，写好的规则被送往netfilter，告诉内核如何去处理信息包</span><br></pre></td></tr></table></figure></p>
<p>firewalld<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CentOS 7 引入了新的前端管理工具</span><br><span class="line">管理工具：</span><br><span class="line">firewall-cmd 命令行</span><br><span class="line">firewall-config 图形</span><br></pre></td></tr></table></figure></p>
<h2 id="iptables的组成"><a href="#iptables的组成" class="headerlink" title="iptables的组成"></a>iptables的组成</h2><p>iptables由五个表和五个链以及一些规则组成<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">五个表table：filter、nat、mangle、raw、security</span><br><span class="line">filter表：过滤规则表，根据预定义的规则过滤符合条件的数据包</span><br><span class="line">nat表：network address translation 地址转换规则表</span><br><span class="line">mangle：修改数据标记位规则表</span><br><span class="line">raw：关闭NAT表上启用的连接跟踪机制，加快封包穿越防火墙速度</span><br><span class="line">security：用于强制访问控制（MAC）网络规则，由Linux安全模块（如SELinux）实现</span><br><span class="line">优先级由高到低的顺序为:security --&gt;raw--&gt;mangle--&gt;nat--&gt;filter</span><br><span class="line"></span><br><span class="line">五个内置链chain</span><br><span class="line">INPUT</span><br><span class="line">OUTPUT</span><br><span class="line">FORWARD</span><br><span class="line">PREROUTING</span><br><span class="line">POSTROUTING</span><br></pre></td></tr></table></figure></p>
<p>Netfilter表和链对应关系<br><img src="/images/iptables2.jpg" alt="Alt text"></p>
<p>数据包过滤匹配流程<br><img src="/images/iptables3.png" alt="Alt text"></p>
<h2 id="IPTABLES和路由"><a href="#IPTABLES和路由" class="headerlink" title="IPTABLES和路由"></a>IPTABLES和路由</h2><pre><code>路由功能发生的时间点
 报文进入本机后
• 判断目标主机是否为本机
是：INPUT
否：FORWARD
 报文离开本机之前
• 判断由哪个接口送往下一跳
</code></pre><p><img src="/images/iptables4.png" alt="Alt text"></p>
<p>内核中数据包的传输过程:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">当一个数据包进入网卡时，数据包首先进入PREROUTING链，内核根据数据包目的IP判断是否需要转送出去</span><br><span class="line"></span><br><span class="line">如果数据包就是进入本机的，数据包就会沿着图向下移动，到达INPUT链。数据包到达INPUT链后，任何进程都会收到它。本机上运行的程序可以发送数据包，这些数据包经过OUTPUT链，然后到达POSTROUTING链输出</span><br><span class="line"></span><br><span class="line">如果数据包是要转发出去的，且内核允许转发，数据包就会向右移动，经过FORWARD链，然后到达POSTROUTING链输出</span><br></pre></td></tr></table></figure></p>
<h1 id="iptables规则"><a href="#iptables规则" class="headerlink" title="iptables规则"></a>iptables规则</h1><p>规则rule：根据规则的匹配条件尝试匹配报文，对匹配成功的报文根据规则定义的处理动作作出处理</p>
<pre><code>匹配条件：默认为与条件，同时满足
基本匹配：IP，端口，TCP的Flags（SYN,ACK等）
扩展匹配：通过复杂高级功能匹配
处理动作：称为target，跳转目标
内建处理动作：ACCEPT,DROP,REJECT,SNAT,DNATMASQUERADE,MARK,LOG...
自定义处理动作：自定义chain，利用分类管理复杂情形
</code></pre><p>规则要添加在链上，才生效；添加在自定义上不会自动生效</p>
<p>链chain：内置链：每个内置链对应于一个钩子函数</p>
<p>自定义链：用于对内置链进行扩展或补充，可实现更灵活的规则组织管理机制；只有Hook钩子调用自定义链时，才生效</p>
<p>iptables规则添加时考量点:</p>
<pre><code> 要实现哪种功能：判断添加在哪张表上
 报文流经的路径：判断添加在哪个链上
 报文的流向：判断源和目的
 匹配规则：业务需要
</code></pre><p>实验环境准备：</p>
<pre><code> Centos7：systemctl stop firewalld.service
systemctl disable firewalld. service

 Centos6：service iptables stop
chkconfig iptables off
</code></pre><h1 id="iptables命令"><a href="#iptables命令" class="headerlink" title="iptables命令"></a>iptables命令</h1><p>规则格式：iptables [-t table] SUBCOMMAND chain [-m matchname] [ per-match-options] -j targetname [ per-target-options]</p>
<p>-t table：raw, mangle, nat, [ filter]默认</p>
<h2 id="SUBCOMMAND："><a href="#SUBCOMMAND：" class="headerlink" title="SUBCOMMAND："></a>SUBCOMMAND：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">1、链管理：</span><br><span class="line">-N：new, 自定义一条新的规则链</span><br><span class="line">-X：delete，删除自定义的空的规则链</span><br><span class="line">-P：Policy，设置默认策略；对filter表中的链而言，其默认策略有：</span><br><span class="line">ACCEPT：接受</span><br><span class="line">DROP：丢弃</span><br><span class="line">-E：重命名自定义链；引用计数不为0的自定义链不能够被重命名，也不能被删除</span><br><span class="line"></span><br><span class="line">2、查看：</span><br><span class="line">-L：list, 列出指定鏈上的所有规则，本选项须置后</span><br><span class="line">-n：numberic，以数字格式显示地址和端口号</span><br><span class="line">-v：verbose，详细信息</span><br><span class="line">-vv 更详细</span><br><span class="line">-x：exactly，显示计数器结果的精确值,而非单位转换后的易读值</span><br><span class="line">--line-numbers：显示规则的序号</span><br><span class="line">常用组合：</span><br><span class="line">-vnL</span><br><span class="line">-vvnxL --line-numbers</span><br><span class="line">-S selected,以iptables-save 命令格式显示链上规则</span><br><span class="line"></span><br><span class="line">3、规则管理：</span><br><span class="line">-A：append，追加</span><br><span class="line">-I：insert, 插入，要指明插入至的规则编号，默认为第一条</span><br><span class="line">-D：delete，删除</span><br><span class="line">    (1) 指明规则序号</span><br><span class="line">    (2) 指明规则本身</span><br><span class="line">-R：replace，替换指定链上的指定规则编号</span><br><span class="line">-F：flush，清空指定的规则链</span><br><span class="line">-Z：zero，置零</span><br><span class="line">    iptables的每条规则都有两个计数器</span><br><span class="line">    (1) 匹配到的报文的个数</span><br><span class="line">    (2) 匹配到的所有报文的大小之和</span><br><span class="line">chain：PREROUTING，INPUT，FORWARD，OUTPUT，POSTROUTING</span><br></pre></td></tr></table></figure>
<h2 id="匹配条件"><a href="#匹配条件" class="headerlink" title="匹配条件"></a>匹配条件</h2><p>基本：通用的，PARAMETERS</p>
<p>扩展：需加载模块，MATCH EXTENTIONS<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">1、基本匹配条件：无需加载模块，由iptables/netfilter自行提供</span><br><span class="line">[!] -s, --source address[/mask][,...]：源IP地址或范围</span><br><span class="line">[!] -d, --destination address[/mask][,...]：目标IP地址或范围</span><br><span class="line">[!] -p, --protocol protocol：指定协议，可使用数字如0（all）</span><br><span class="line">    protocol: tcp, udp, icmp, icmpv6, udplite,esp, ah, sctp, mh or“all“ </span><br><span class="line">    参看：/etc/protocols</span><br><span class="line">[!] -i, --in-interface name：报文流入的接口；只能应用于数据报文流入环节，只应用于INPUT、FORWARD、PREROUTING链</span><br><span class="line">[!] -o, --out-interface name：报文流出的接口；只能应用于数据报文流出的环节，只应用于FORWARD、OUTPUT、POSTROUTING链</span><br><span class="line"></span><br><span class="line">2 扩展匹配条件：需要加载扩展模块（/usr/lib64/xtables/*.so），方可生效</span><br><span class="line">查看帮助 man iptables-extensions</span><br><span class="line"></span><br><span class="line">(1)隐式扩展：在使用-p选项指明了特定的协议时，无需再用-m选项指明扩展模块</span><br><span class="line">的扩展机制，不需要手动加载扩展模块</span><br><span class="line">tcp协议的扩展选项</span><br><span class="line">[!] --source-port, --sport port[:port]：匹配报文源端口,可为端口范围</span><br><span class="line">[!] --destination-port,--dport port[:port]：匹配报文目标端口,可为范围</span><br><span class="line">[!]  --tcp-flags mask comp</span><br><span class="line">    mask 需检查的标志位列表，用,分隔</span><br><span class="line">    例如 SYN,ACK,FIN,RST</span><br><span class="line">    comp 在mask列表中必须为1的标志位列表，无指定则必须为0，用,分隔</span><br><span class="line"></span><br><span class="line">示例：</span><br><span class="line">--tcp-flags SYN,ACK,FIN,RST SYN 表示要检查的标志位为</span><br><span class="line">SYN,ACK,FIN,RST四个，其中SYN必须为1，余下的必须为0</span><br><span class="line">--tcp-flags SYN,ACK,FIN,RST SYN,ACK </span><br><span class="line">--tcp-flags ALL ALL</span><br><span class="line">--tcp_flags ALL NONE</span><br><span class="line"></span><br><span class="line">[!] --syn：用于匹配第一次握手</span><br><span class="line">相当于：--tcp-flags SYN,ACK,FIN,RST SYN</span><br><span class="line"></span><br><span class="line">udp</span><br><span class="line">[!] --source-port, --sport port[:port]：匹配报文的源端口或端口范围</span><br><span class="line">[!] --destination-port,--dport port[:port]：匹配报文的目标端口或端口范围</span><br><span class="line"></span><br><span class="line">icmp</span><br><span class="line">[!] --icmp-type &#123;type[/code]|typename&#125;</span><br><span class="line">    type/code</span><br><span class="line">        0/0 echo-reply icmp应答</span><br><span class="line">        8/0 echo-request icmp请求</span><br><span class="line"></span><br><span class="line">(2)显式扩展：必须使用-m选项指明要调用的扩展模块的扩展机制，要手动加载扩</span><br><span class="line">展模块</span><br><span class="line">        [-m matchname [per-match-options]]</span><br><span class="line">处理动作：</span><br><span class="line">-j targetname [per-target-options]</span><br><span class="line">简单：ACCEPT，DROP</span><br><span class="line">扩展：REJECT：--reject-with:icmp-port-unreachable默认</span><br><span class="line">RETURN：返回调用链</span><br><span class="line">REDIRECT：端口重定向</span><br><span class="line">LOG：记录日志，dmesg</span><br><span class="line">MARK：做防火墙标记</span><br><span class="line">DNAT：目标地址转换</span><br><span class="line">SNAT：源地址转换</span><br><span class="line">MASQUERADE：地址伪装</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">显式扩展：必须显式地指明使用的扩展模块进行的扩展</span><br></pre></td></tr></table></figure></p>
<h2 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h2><p>使用帮助：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">CentOS 6: man iptables</span><br><span class="line">CentOS 7: man iptables-extensions</span><br><span class="line"></span><br><span class="line">1、multiport扩展</span><br><span class="line">以离散方式定义多端口匹配,最多指定15个端口</span><br><span class="line">[!] --source-ports,--sports port[,port|,port:port]...</span><br><span class="line">指定多个源端口</span><br><span class="line">[!] --destination-ports,--dports port[,port|,port:port]...</span><br><span class="line">指定多个目标端口</span><br><span class="line">[!] --ports port[,port|,port:port]...多个源或目标端口</span><br><span class="line"></span><br><span class="line">示例：</span><br><span class="line">iptables -A INPUT -s 172.16.0.0/16 -d 172.16.100.10 -p tcp -m multiport --dports20:22,80 -j ACCEPT</span><br><span class="line"></span><br><span class="line">2、iprange扩展</span><br><span class="line">指明连续的（但一般不是整个网络）ip地址范围</span><br><span class="line">[!] --src-range from[-to] 源IP地址范围</span><br><span class="line">[!] --dst-range from[-to] 目标IP地址范围</span><br><span class="line"></span><br><span class="line">示例：</span><br><span class="line">iptables -A INPUT -d 172.16.1.100 -p tcp --dport 80 -m iprange --srcrange 172.16.1.5-172.16.1.10 -j DROP</span><br><span class="line"></span><br><span class="line">3、mac扩展</span><br><span class="line">指明源MAC地址</span><br><span class="line">适用于：PREROUTING, FORWARD，INPUT chains</span><br><span class="line">[!] --mac-source XX:XX:XX:XX:XX:XX</span><br><span class="line"></span><br><span class="line">示例：</span><br><span class="line">iptables -A INPUT -s 172.16.0.100 -m mac --mac-source 00:50:56:12:34:56 -j ACCEPT</span><br><span class="line">iptables -A INPUT -s 172.16.0.100 -j REJECT</span><br><span class="line"></span><br><span class="line">4、string扩展</span><br><span class="line">对报文中的应用层数据做字符串模式匹配检测</span><br><span class="line">--algo &#123;bm|kmp&#125; 字符串匹配检测算法</span><br><span class="line">bm：Boyer-Moore</span><br><span class="line">kmp：Knuth-Pratt-Morris</span><br><span class="line">--from offset 开始偏移</span><br><span class="line">--to offset 结束偏移</span><br><span class="line">[!] --string pattern 要检测的字符串模式</span><br><span class="line">[!] --hex-string pattern要检测字符串模式，16进制格式</span><br><span class="line"></span><br><span class="line">示例：</span><br><span class="line">iptables -A OUTPUT -s 172.16.100.10 -d 0/0 -p tcp --sport 80 -m string --algo bm --string “google&quot; -j REJECT</span><br><span class="line"></span><br><span class="line">5、time扩展</span><br><span class="line">根据将报文到达的时间与指定的时间范围进行匹配</span><br><span class="line">--datestart YYYY[-MM[-DD[Thh[:mm[:ss]]]]] 日期</span><br><span class="line">--datestop YYYY[-MM[-DD[Thh[:mm[:ss]]]]]</span><br><span class="line">--timestart hh:mm[:ss] 时间</span><br><span class="line">--timestop hh:mm[:ss]</span><br><span class="line">[!] --monthdays day[,day...] 每个月的几号</span><br><span class="line">[!] --weekdays day[,day...] 星期几，1 – 7 分别表示星期一到星期日</span><br><span class="line">--kerneltz：内核时区，不建议使用，CentOS7系统默认为UTC</span><br><span class="line">注意： centos6 不支持kerneltz ，--localtz指定本地时区(默认)</span><br><span class="line"></span><br><span class="line">示例：</span><br><span class="line">iptables -A INPUT -s 172.16.0.0/16 -d 172.16.100.10 -p tcp --dport 80 -m time --timestart 14:30 --timestop 18:30 --weekdays Sat,Sun --kerneltz -j DROP</span><br><span class="line"></span><br><span class="line">6、connlimit扩展</span><br><span class="line">根据每客户端IP做并发连接数数量匹配</span><br><span class="line">可防止CC(Challenge Collapsar挑战黑洞)攻击</span><br><span class="line">--connlimit-upto #：连接的数量小于等于#时匹配</span><br><span class="line">--connlimit-above #：连接的数量大于#时匹配</span><br><span class="line">通常分别与默认的拒绝或允许策略配合使用</span><br><span class="line"></span><br><span class="line">示例：</span><br><span class="line">iptables -A INPUT -d 172.16.100.10 -p tcp --dport 22 -m connlimit --</span><br><span class="line">connlimit-above 2 -j REJECT</span><br><span class="line"></span><br><span class="line">7、limit扩展</span><br><span class="line">基于收发报文的速率做匹配</span><br><span class="line">令牌桶过滤器</span><br><span class="line">--limit #[/second|/minute|/hour|/day]</span><br><span class="line">--limit-burst number</span><br><span class="line"></span><br><span class="line">示例：</span><br><span class="line">iptables -I INPUT -d 172.16.100.10 -p icmp --icmp-type 8 -m limit --limit 10/minute --limit-burst 5 -j ACCEPT</span><br><span class="line">iptables -I INPUT 2 -p icmp -j REJECT</span><br><span class="line"></span><br><span class="line">8、state扩展</span><br><span class="line">    根据”连接追踪机制“去检查连接的状态，较耗资源</span><br><span class="line">conntrack机制：追踪本机上的请求和响应之间的关系</span><br><span class="line">状态有如下几种：</span><br><span class="line">        NEW：新发出请求；连接追踪信息库中不存在此连接的相关信息条目，因此，将其识别为第一次发出的请求</span><br><span class="line">        ESTABLISHED：NEW状态之后，连接追踪信息库中为其建立的条目失效之前期间内所进行的通信状态</span><br><span class="line">        RELATED：新发起的但与已有连接相关联的连接，如：ftp协议中的数据连接与命令连接之间的关系</span><br><span class="line">        INVALID：无效的连接，如flag标记不正确</span><br><span class="line">        UNTRACKED：未进行追踪的连接，如raw表中关闭追踪</span><br><span class="line">[!] --state state</span><br><span class="line"></span><br><span class="line">示例：</span><br><span class="line">iptables -A INPUT -d 172.16.1.10 -p tcp -m multiport --dports 22,80 -m state --state NEW,ESTABLISHED -j ACCEPT</span><br><span class="line">iptables -A OUTPUT -s 172.16.1.10 -p tcp -m multiport --sports 22,80 -m state --state ESTABL</span><br></pre></td></tr></table></figure></p>
<h1 id="iptables调试"><a href="#iptables调试" class="headerlink" title="iptables调试"></a>iptables调试</h1><pre><code>已经追踪到的并记录下来的连接信息库
/proc/net/nf_conntrack
调整连接追踪功能所能够容纳的最大连接数量
/proc/sys/net/nf_conntrack_max
不同的协议的连接追踪时长
/proc/sys/net/netfilter/
注意：CentOS7 需要加载模块： modprobe nf_conntrack
</code></pre><p>iptables的链接跟踪表最大容量为/proc/sys/net/nf_conntrack_max，各种状态的超时链接会从表中删除；当模板满载时，后续连接可能会超时<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">解决方法两个：</span><br><span class="line">(1) 加大nf_conntrack_max 值</span><br><span class="line">vi /etc/sysctl.conf</span><br><span class="line">net.nf_conntrack_max = 393216</span><br><span class="line">net.netfilter.nf_conntrack_max = 393216</span><br><span class="line">(2) 降低 nf_conntrack timeout时间</span><br><span class="line">vi /etc/sysctl.conf</span><br><span class="line">net.netfilter.nf_conntrack_tcp_timeout_established = 300</span><br><span class="line">net.netfilter.nf_conntrack_tcp_timeout_time_wait = 120</span><br><span class="line">net.netfilter.nf_conntrack_tcp_timeout_close_wait = 60</span><br><span class="line">net.netfilter.nf_conntrack_tcp_timeout_fin_wait = 120</span><br><span class="line">iptables -t nat -L -n</span><br></pre></td></tr></table></figure></p>
<h1 id="开放被动模式的ftp服务"><a href="#开放被动模式的ftp服务" class="headerlink" title="开放被动模式的ftp服务"></a>开放被动模式的ftp服务</h1><p>(1) 装载ftp连接追踪的专用模块：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">跟踪模块路径：/lib/modules/kernelversion/kernel/net/netfilter</span><br><span class="line">vim /etc/sysconfig/iptables-config 配置文件</span><br><span class="line">IPTABLES_MODULES=“nf_conntrack_ftp&quot;</span><br><span class="line">modproble nf_conntrack_ftp</span><br></pre></td></tr></table></figure></p>
<p>(2) 放行请求报文：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">命令连接：NEW, ESTABLISHED</span><br><span class="line">数据连接：RELATED, ESTABLISHED</span><br><span class="line">iptables –I INPUT -d LocalIP -p tcp -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line">iptables -A INPUT -d LocalIP -p tcp --dport 21 -m state --state NEW -j ACCEPT</span><br></pre></td></tr></table></figure></p>
<p>(3) 放行响应报文：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -I OUTPUT -s LocalIP -p tcp -m state --state ESTABLISHED -j ACCEPT</span><br></pre></td></tr></table></figure></p>
<p>开放被动模式的ftp服务示例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">yum install vsftpd</span><br><span class="line">systemctl start vsftpd</span><br><span class="line">modprobe nf_conntrack_ftp</span><br><span class="line">iptables -F</span><br><span class="line">iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line">iptables -A INPUT -p tcp --dport 21 -m state --state NEW -j ACCEPT</span><br><span class="line">iptables -A OUTPUT -m state --state ESTABLISHED -j ACCEPT</span><br><span class="line">iptables -P INPUT DROP</span><br><span class="line">iptables -P OUTPUT DROP</span><br><span class="line">iptables -vnL</span><br></pre></td></tr></table></figure></p>
<h1 id="Target"><a href="#Target" class="headerlink" title="Target"></a>Target</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ACCEPT， DROP， REJECT， RETURN</span><br><span class="line">LOG， SNAT， DNAT， REDIRECT， MASQUERADE，..</span><br><span class="line">LOG：非中断target,本身不拒绝和允许,放在拒绝和允许规则前</span><br><span class="line"></span><br><span class="line">并将日志记录在/var/log/messages系统日志中</span><br><span class="line">--log-level level 级别： debug，info，notice, warning, error, crit, alert,emerg</span><br><span class="line">--log-prefix prefix 日志前缀，用于区别不同的日志，最多29个字符</span><br><span class="line"></span><br><span class="line">示例：</span><br><span class="line">iptables -I INPUT -s 10.0.1.0/24 -p tcp -m multiport --dports</span><br><span class="line">80,21,22,23 -m state --state NEW -j LOG --log-prefix &quot;new connections: &quot;</span><br></pre></td></tr></table></figure>
<p>任何不允许的访问，应该在请求到达时给予拒绝</p>
<p>规则在链接上的次序即为其检查时的生效次序</p>
<p>基于上述，规则优化</p>
<pre><code>1 安全放行所有入站和出站的状态为ESTABLISHED状态连接
2 谨慎放行入站的新请求
3 有特殊目的限制访问功能，要在放行规则之前加以拒绝
4 同类规则（访问同一应用），匹配范围小的放在前面，用于特殊处理
5 不同类的规则（访问不同应用），匹配范围大的放在前面
6 应该将那些可由一条规则能够描述的多个规则合并为一条
7 设置默认策略，建议白名单（只放行特定连接）
    1） iptables -P，不建议
    2） 建议在规则的最后定义规则做为默认策略
</code></pre><p>规则有效期限：使用iptables命令定义的规则，手动删除之前，其生效期限为kernel存活期限</p>
<h1 id="保存规则"><a href="#保存规则" class="headerlink" title="保存规则"></a>保存规则</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">保存规则至指定的文件</span><br><span class="line">CentOS 6 </span><br><span class="line">service iptables save </span><br><span class="line">将规则覆盖保存至/etc/sysconfig/iptables文件中</span><br><span class="line">CentOS 7</span><br><span class="line">iptables-save &gt; /PATH/TO/SOME_RULES_FILE</span><br><span class="line"></span><br><span class="line">CentOS 6：</span><br><span class="line">service iptables restart</span><br><span class="line">会自动从/etc/sysconfig/iptables 重新载入规则</span><br><span class="line"></span><br><span class="line">CentOS 7 重新载入预存规则文件中规则：</span><br><span class="line">iptables-restore &lt; /PATH/FROM/SOME_RULES_FILE</span><br><span class="line">-n, --noflush：不清除原有规则</span><br><span class="line">-t, --test：仅分析生成规则集，但不提交</span><br></pre></td></tr></table></figure>
<h1 id="开机自动重载规则"><a href="#开机自动重载规则" class="headerlink" title="开机自动重载规则"></a>开机自动重载规则</h1><p>开机自动重载规则文件中的规则<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(1) 用脚本保存各iptables命令；让此脚本开机后自动运行</span><br><span class="line">/etc/rc.d/rc.local文件中添加脚本路径</span><br><span class="line">/PATH/TO/SOME_SCRIPT_FILE</span><br><span class="line">(2) 用规则文件保存各规则，开机时自动载入此规则文件中的规则</span><br><span class="line">/etc/rc.d/rc.local文件添加</span><br><span class="line">iptables-restore &lt; /PATH/FROM/IPTABLES_RULES_FILE</span><br><span class="line">(3)自定义Unit File，进行iptables-restore</span><br></pre></td></tr></table></figure></p>
<h1 id="iptables-netfilter网络防火墙"><a href="#iptables-netfilter网络防火墙" class="headerlink" title="iptables/netfilter网络防火墙"></a>iptables/netfilter网络防火墙</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(1) 充当网关</span><br><span class="line">(2) 使用filter表的FORWARD链</span><br><span class="line">注意的问题：</span><br><span class="line">(1) 请求-响应报文均会经由FORWARD链，要注意规则的方向性</span><br><span class="line">(2) 如果要启用conntrack机制，建议将双方向的状态为ESTABLISHED的报文直接放行</span><br></pre></td></tr></table></figure>
<h2 id="NAT"><a href="#NAT" class="headerlink" title="NAT"></a>NAT</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">NAT: network address translation</span><br><span class="line">    PREROUTING，INPUT，OUTPUT，POSTROUTING</span><br><span class="line">    请求报文：修改源/目标IP，由定义如何修改</span><br><span class="line">    响应报文：修改源/目标IP，根据跟踪机制自动实现</span><br><span class="line">SNAT：source NAT POSTROUTING, INPUT</span><br><span class="line">    让本地网络中的主机通过某一特定地址访问外部网络，实现地址伪装请求报文：修改源IP</span><br><span class="line">DNAT：destination NAT PREROUTING , OUTPUT</span><br><span class="line">    把本地网络中的主机上的某服务开放给外部网络访问(发布服务和端口映射)，但隐藏真实IP</span><br><span class="line">    请求报文：修改目标IP</span><br><span class="line">PNAT: port nat，端口和IP都进行修改</span><br></pre></td></tr></table></figure>
<h2 id="SNAT"><a href="#SNAT" class="headerlink" title="SNAT"></a>SNAT</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">nat表的target：</span><br><span class="line">SNAT：固定IP</span><br><span class="line">--to-source [ipaddr[-ipaddr]][:port[-port]]</span><br><span class="line">--random</span><br><span class="line">iptables -t nat -A POSTROUTING -s LocalNET ! -d LocalNet -j SNAT --tosource ExtIP</span><br><span class="line"></span><br><span class="line">示例：</span><br><span class="line">iptables -t nat -A POSTROUTING -s 10.0.1.0/24 ! –d 10.0.1.0/24 -j SNAT --to-source 172.18.1.6-172.18.1.9</span><br><span class="line"></span><br><span class="line">MASQUERADE：动态IP，如拨号网络</span><br><span class="line">    --to-ports port[-port]</span><br><span class="line">    --random</span><br><span class="line">iptables -t nat -A POSTROUTING -s LocalNET ! -d LocalNet -j MASQUERADE</span><br><span class="line"></span><br><span class="line">示例：</span><br><span class="line">iptables -t nat -A POSTROUTING -s 10.0.1.0/24 ! –d 10.0.1.0/24 -j MASQUERADE</span><br></pre></td></tr></table></figure>
<h2 id="DNAT"><a href="#DNAT" class="headerlink" title="DNAT"></a>DNAT</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">DNAT</span><br><span class="line">    --to-destination [ipaddr[-ipaddr]][:port[-port]]</span><br><span class="line">iptables -t nat -A PREROUTING -d ExtIP -p tcp|udp --dport PORT -j DNAT --to-destination InterSeverIP[:PORT]</span><br><span class="line"></span><br><span class="line">示例：</span><br><span class="line">iptables -t nat -A PREROUTING -s 0/0 -d 172.18.100.6 -p tcp --dport 22 -j DNAT --to-destination 10.0.1.22</span><br><span class="line"></span><br><span class="line">iptables -t nat -A PREROUTING -s 0/0 -d 172.18.100.6 -p tcp --dport 80 -j DNAT --to-destination 10.0.1.22:8080</span><br></pre></td></tr></table></figure>
<h1 id="转发"><a href="#转发" class="headerlink" title="转发"></a>转发</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">REDIRECT：</span><br><span class="line">    NAT表</span><br><span class="line">    可用于：PREROUTING OUTPUT 自定义链</span><br><span class="line">    通过改变目标IP和端口，将接受的包转发至不同端口</span><br><span class="line">    --to-ports port[-port]</span><br><span class="line"></span><br><span class="line">示例：</span><br><span class="line">iptables -t nat -A PREROUTING -d 172.16.100.10 -p tcp --dport 80 -j REDIRECT --to-ports 8080</span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/12/20/Inotify和rsync实现数据实时同步/" rel="next" title="Inotify和rsync实现数据实时同步">
                <i class="fa fa-chevron-left"></i> Inotify和rsync实现数据实时同步
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/12/27/KVM虚拟化/" rel="prev" title="KVM虚拟化">
                KVM虚拟化 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/yy.jpg"
                alt="WPY" />
            
              <p class="site-author-name" itemprop="name">WPY</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">63</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">63</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#安全技术"><span class="nav-number">1.</span> <span class="nav-text">安全技术</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#防火墙的分类"><span class="nav-number">2.</span> <span class="nav-text">防火墙的分类</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#网络型防火墙"><span class="nav-number">2.1.</span> <span class="nav-text">网络型防火墙</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#应用层防火墙"><span class="nav-number">2.2.</span> <span class="nav-text">应用层防火墙</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#iptables的基本认识"><span class="nav-number">3.</span> <span class="nav-text">iptables的基本认识</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Netfilter组件"><span class="nav-number">3.1.</span> <span class="nav-text">Netfilter组件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三种报文流向"><span class="nav-number">3.2.</span> <span class="nav-text">三种报文流向</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#防火墙工具"><span class="nav-number">3.3.</span> <span class="nav-text">防火墙工具</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#iptables的组成"><span class="nav-number">3.4.</span> <span class="nav-text">iptables的组成</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IPTABLES和路由"><span class="nav-number">3.5.</span> <span class="nav-text">IPTABLES和路由</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#iptables规则"><span class="nav-number">4.</span> <span class="nav-text">iptables规则</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#iptables命令"><span class="nav-number">5.</span> <span class="nav-text">iptables命令</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#SUBCOMMAND："><span class="nav-number">5.1.</span> <span class="nav-text">SUBCOMMAND：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#匹配条件"><span class="nav-number">5.2.</span> <span class="nav-text">匹配条件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#扩展"><span class="nav-number">5.3.</span> <span class="nav-text">扩展</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#iptables调试"><span class="nav-number">6.</span> <span class="nav-text">iptables调试</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#开放被动模式的ftp服务"><span class="nav-number">7.</span> <span class="nav-text">开放被动模式的ftp服务</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Target"><span class="nav-number">8.</span> <span class="nav-text">Target</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#保存规则"><span class="nav-number">9.</span> <span class="nav-text">保存规则</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#开机自动重载规则"><span class="nav-number">10.</span> <span class="nav-text">开机自动重载规则</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#iptables-netfilter网络防火墙"><span class="nav-number">11.</span> <span class="nav-text">iptables/netfilter网络防火墙</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#NAT"><span class="nav-number">11.1.</span> <span class="nav-text">NAT</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SNAT"><span class="nav-number">11.2.</span> <span class="nav-text">SNAT</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DNAT"><span class="nav-number">11.3.</span> <span class="nav-text">DNAT</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#转发"><span class="nav-number">12.</span> <span class="nav-text">转发</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">WPY</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>
